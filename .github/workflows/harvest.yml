name: Market Lion Daily Harvest

on:
  # 1. Schedule: Runs at 21:05 UTC (17:05 ET) Mon-Fri
  # This is 00:05 in Bahrain, which is after market close.
  schedule:
    - cron: '5 21 * * 1-5'
  
  # 2. Manual Trigger: Allows you to run it anytime from the "Actions" tab
  workflow_dispatch:

jobs:
  harvest-job:
    # Use a standard virtual machine
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Get your code from the repository
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 2: Set up the Python version
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12' # Make sure this matches your local version

      # Step 3: Install all libraries from requirements.txt
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Run your worker script, injecting the secrets
      - name: Run Harvester Worker
        env:
          TURSO_DB_URL: ${{ secrets.TURSO_DB_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          CAPITAL_X_CAP_API_KEY: ${{ secrets.CAPITAL_X_CAP_API_KEY }}
          CAPITAL_IDENTIFIER: ${{ secrets.CAPITAL_IDENTIFIER }}
          CAPITAL_PASSWORD: ${{ secrets.CAPITAL_PASSWORD }}
        run: python worker.py